 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCOP Protocol - Licitación y Trazabilidad Ambiental</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>

    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #66BB6A;
            --accent-color: #4CAF50;
            --dark-color: #1B5E20;
            --light-bg: #F1F8E9;
            --licitacion-color: #546E7A;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        
        /* --- Navbar --- */
        .navbar { background-color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .navbar-brand, .nav-link { color: white !important; }
        .nav-link.active { background-color: var(--secondary-color); border-radius: 5px; }

        /* --- Hero Section --- */
        .hero-section { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 60px 0; margin-bottom: 30px; }
        .fund-flow { display: flex; justify-content: space-between; align-items: center; margin: 40px 0; position: relative; }
        .fund-flow::before { content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 3px; background: linear-gradient(90deg, var(--secondary-color), var(--accent-color)); z-index: 1; }
        .fund-step { background-color: white; border: 3px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; z-index: 2; position: relative; font-size: 1.5rem; color: var(--primary-color); }
        .fund-step.active { background-color: var(--primary-color); color: white; }
        .fund-step-label { position: absolute; bottom: -25px; white-space: nowrap; font-size: 0.8rem; width: 100px; text-align: center; color: white; font-weight: 500; }
        @media (max-width: 768px) {
            .fund-flow { flex-direction: column; height: auto; }
            .fund-flow::before { width: 2px; height: 100%; top: 0; left: 50%; }
            .fund-step { margin: 15px 0; }
            .fund-step-label { bottom: auto; left: 70px; top: 50%; transform: translateY(-50%); text-align: left; }
        }

        /* --- Cards & Components --- */
        .stats-card, .project-card, .filter-section, .about-section, .contact-section, .licitacion-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .stats-card:hover, .project-card:hover, .licitacion-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .stats-card .card-icon { font-size: 2.5rem; color: var(--primary-color); }
        .project-img, .licitacion-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px;}
        .project-header, .licitacion-header { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); }
        .project-tags, .licitacion-tags { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
        .tag { background-color: var(--light-bg); color: var(--dark-color); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }
        .amount-highlight { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); }
        .progress { height: 10px; border-radius: 5px; }
        .progress-bar { background-color: var(--secondary-color); }
        .badge-status { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
        .status-pending { background-color: #FFF3E0; color: #E65100; }
        .status-in-progress { background-color: #E3F2FD; color: #0D47A1; }
        .status-verified { background-color: #E8F5E9; color: #1B5E20; }
        .status-closed { background-color: #F3E5F5; color: #4A148C; }
        .status-study { background-color: #EDE7F6; color: #4527A0; }
        .status-requesting { background-color: #FFF8E1; color: #F57F17; }
        .status-licitacion { background-color: #ECEFF1; color: var(--licitacion-color); font-weight: bold; border: 1px solid #cfd8dc; }
        
        .budget-list { list-style: none; padding-left: 0; }
        .budget-list li { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .budget-list li:last-child { border-bottom: none; font-weight: bold; color: var(--primary-color); }

        /* --- Map & Traceability --- */
        #map { height: 400px; border-radius: 10px; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid var(--primary-color); }
        .trace-step { position: relative; padding-left: 40px; margin-bottom: 20px; }
        .trace-step::before { content: ''; position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background-color: var(--secondary-color); }
        .trace-step:last-child::before { display: none; }
        .trace-icon { position: absolute; left: 0; top: 0; width: 32px; height: 32px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }

        /* --- Call to Action Section --- */
        .cta-section {
            background: linear-gradient(rgba(46, 125, 50, 0.8), rgba(46, 125, 50, 0.8)), url('https://picsum.photos/seed/forest_team/1920/600.jpg') no-repeat center center/cover;
            color: white;
            padding: 80px 0;
            margin-top: 50px;
        }
        .cta-section h2 { font-size: 2.5rem; font-weight: bold; }
        .cta-section p { font-size: 1.2rem; }

        /* --- Footer & Modals --- */
        .footer { background-color: var(--dark-color); color: white; padding: 30px 0; margin-top: 0; }
        .modal-header { background-color: var(--primary-color); color: white; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert-container { position: fixed; top: 80px; right: 20px; z-index: 1050; max-width: 350px; }
    </style>
</head>
<body>

    <!-- Alert Container for Notifications -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#inicio">CCOP Protocol</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" href="#inicio">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#licitacion">En Licitación</a></li>
                    <li class="nav-item"><a class="nav-link" href="#proyectos">Proyectos Activos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#trazabilidad">Trazabilidad</a></li>
                    <li class="nav-item"><a class="nav-link" href="#quienes-somos">Quienes Somos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#contactanos">Contáctanos</a></li>
                    <li class="nav-item d-flex align-items-center ms-3">
                        <div id="walletConnectionArea"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="inicio">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-4">Financia y Sigue el Impacto Ambiental Real</h1>
            <p class="lead mb-4">Participa en licitaciones transparentes y sigue cada peso destinado a proyectos que transforman Colombia. Conecta tu billetera y sé parte del cambio.</p>
            <div class="d-flex gap-3 justify-content-center">
                <button class="btn btn-light btn-lg" onclick="scrollToSection('licitacion')">
                    <i class="bi bi-bullseye me-2"></i>Ver Proyectos en Licitación
                </button>
                <button class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#howItWorksModal">
                    <i class="bi bi-play-circle me-2"></i>Cómo Funciona
                </button>
            </div>
            <div class="fund-flow mt-5">
                <div class="fund-step active"><i class="bi bi-bullseye"></i><span class="fund-step-label">Licitación</span></div>
                <div class="fund-step active"><i class="bi bi-cash"></i><span class="fund-step-label">Fondos COP</span></div>
                <div class="fund-step active"><i class="bi bi-currency-exchange"></i><span class="fund-step-label">Conversión CCOP</span></div>
                <div class="fund-step active"><i class="bi bi-geo-alt"></i><span class="fund-step-label">Ejecución</span></div>
                <div class="fund-step active"><i class="bi bi-check-circle"></i><span class="fund-step-label">Verificación</span></div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container">
        <!-- Stats Section -->
        <section class="row text-center mb-5">
            <div class="col-md-3 col-sm-6"><div class="stats-card"><div class="card-icon"><i class="bi bi-bullseye"></i></div><h3 class="fw-bold">4</h3><p class="text-muted">Proyectos en Licitación</p></div></div>
            <div class="col-md-3 col-sm-6"><div class="stats-card"><div class="card-icon"><i class="bi bi-diagram-3"></i></div><h3 class="fw-bold" id="activeProjects">5</h3><p class="text-muted">Proyectos Activos</p></div></div>
            <div class="col-md-3 col-sm-6"><div class="stats-card"><div class="card-icon"><i class="bi bi-currency-exchange"></i></div><h3 class="fw-bold">$2.1B</h3><p class="text-muted">Capital en Movimiento</p></div></div>
            <div class="col-md-3 col-sm-6"><div class="stats-card"><div class="card-icon"><i class="bi bi-check-circle"></i></div><h3 class="fw-bold">100%</h3><p class="text-muted">Trazabilidad</p></div></div>
        </section>

        <!-- Licitación Section -->
        <section id="licitacion">
            <h2 class="mb-4">Proyectos en Licitación - Únete a la Causa</h2>
            <div class="row" id="licitacionContainer">
                <!-- Licitación cards will be dynamically loaded here -->
            </div>
        </section>

        <!-- Map Section -->
        <section class="mb-5">
            <h2 class="mb-4">Ubicación de Proyectos y Licitaciones</h2>
            <div id="map"></div>
        </section>

        <!-- Active Projects Section -->
        <section id="proyectos">
            <h2 class="mb-4">Proyectos en Ejecución</h2>
            <div class="row" id="projectsContainer">
                <!-- Active project cards will be dynamically loaded here -->
            </div>
        </section>

        <!-- Traceability Section -->
        <section class="about-section" id="trazabilidad">
            <h2 class="mb-4">Trazabilidad de Recursos</h2>
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card border-0 shadow">
                        <div class="card-body p-5">
                            <h4 class="mb-4">Flujo Completo de un Proyecto</h4>
                            <div class="trace-step"><div class="trace-icon"><i class="bi bi-bullseye"></i></div><h6>1. Licitación Pública</h6><p>Los proyectos se publican con presupuesto detallado para atraer financiadores.</p></div>
                            <div class="trace-step"><div class="trace-icon"><i class="bi bi-cash"></i></div><h6>2. Recepción de Fondos</h6><p>Los recursos en COP ingresan y se convierten a CCOP en la blockchain.</p></div>
                            <div class="trace-step"><div class="trace-icon"><i class="bi bi-geo-alt"></i></div><h6>3. Ejecución en Campo</h6><p>La organización ejecuta actividades y reporta avances con evidencia.</p></div>
                            <div class="trace-step"><div class="trace-icon"><i class="bi bi-check-circle"></i></div><h6>4. Verificación y Cierre</h6><p>Se valida el impacto y se registra permanentemente en blockchain.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quienes Somos Section -->
        <section class="about-section" id="quienes-somos">
            <h2 class="mb-4">Quienes Somos</h2>
            <p>Somos CCOP, una plataforma innovadora basada en blockchain para la trazabilidad de proyectos ambientales. Garantizamos transparencia total en el uso de recursos, desde la donación hasta el impacto real en el medio ambiente.</p>
            <ul><li><strong>Misión:</strong> Proporcionar herramientas de trazabilidad inmutable.</li><li><strong>Visión:</strong> Un mundo donde cada peso invertido en el ambiente sea auditable.</li><li><strong>Valores:</strong> Transparencia, innovación y compromiso.</li></ul>
        </section>

        <!-- Contáctanos Section -->
        <section class="contact-section" id="contactanos">
            <h2 class="mb-4">Contáctanos</h2>
            <p>¿Quieres rastrear tus proyectos o colaborar con nosotros? Envíanos un mensaje.</p>
            <form id="contactForm">
                <input type="text" class="form-control mb-3" placeholder="Tu Nombre" required>
                <input type="email" class="form-control mb-3" placeholder="Tu Email" required>
                <textarea class="form-control mb-3" rows="5" placeholder="Tu Mensaje" required></textarea>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
        </section>
    </main>

    <!-- Call to Action Section -->
    <section class="cta-section" id="contactanos-cta">
        <div class="container text-center">
            <h2 class="mb-4">Impulsa el Cambio con Nosotros</h2>
            <p class="lead mb-5">
                <strong>Misión:</strong> Facilitar la financiación transparente y el seguimiento riguroso de proyectos ambientales en Colombia a través de la tecnología blockchain, garantizando que cada recurso genere un impacto medible y duradero.<br><br>
                <strong>Visión:</strong> Convertirnos en la plataforma líder de confianza que conecta a financiadores, organizaciones y ciudadanos en un ecosistema de sostenibilidad verificable, transformando la manera en que se protegen nuestros recursos naturales.
            </p>
            <a href="mailto:contacto@ccop-protocol.com" class="btn btn-warning btn-lg">
                <i class="bi bi-envelope-fill me-2"></i>Contáctanos para Financiar
            </a>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer text-center">
        <div class="container">
            <p>&copy; 2024 CCOP Protocol. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Modals -->
    <!-- How It Works Modal -->
    <div class="modal fade" id="howItWorksModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Cómo Funciona</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="accordion" id="howItWorksAccordion">
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">1. Explora y Financia</button></h2><div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#howItWorksAccordion"><div class="accordion-body"><p>Explora los proyectos en licitación y elige aquel con el que quieras contribuir. Cada proyecto tiene un presupuesto detallado y un plan de acción claro.</p></div></div></div>
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">2. Trazabilidad en Blockchain</button></h2><div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#howItWorksAccordion"><div class="accordion-body"><p>Tu financiación se convierte en tokens CCOP y se registra en la blockchain de Celo, permitiendo un seguimiento transparente e inmutable de cada peso.</p></div></div></div>
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">3. Verifica el Impacto</button></h2><div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#howItWorksAccordion"><div class="accordion-body"><p>Recibe reportes de progreso y evidencias (fotos, videos, datos) directamente de los equipos en campo. Los auditores independientes validan los resultados.</p></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Requisitos Modal -->
    <div class="modal fade" id="requisitosModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="requisitosModalTitle">Requisitos del Proyecto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="requisitosModalBody">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>
    </div>

    <!-- Planos Modal -->
    <div class="modal fade" id="planosModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="planosModalTitle">Planos del Proyecto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="planosModalBody">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURACIÓN DE BLOCKCHAIN ---
        const CELO_MAINNET_RPC_URL = "https://forno.celo.org";
        const CELO_CHAIN_ID = 42220;
        const CELO_CHAIN_ID_HEX = "0xa4ec";
        let provider, signer, userAddress = null;

        // --- DATOS DE PROYECTOS ---
        const mockLicitacionProjects = [
            {
                id: 'LIC-001', title: "Restauración de Corales en San Andrés", image: "https://picsum.photos/seed/coral_san_andres/800/400.jpg",
                description: "Restauración de 10 hectáreas de arrecifes de coral dañados mediante micro-fragmentación. Incluye capacitación a pescadores locales.",
                capital: 450000000, location: [12.5847, -81.7006],
                requisitos: {
                    tecnicos: ["Experiencia demostrada en restauración de arrecifes.", "Capacidad para operar en zonas marinas protegidas."],
                    financieros: ["Capacidad de inversión mínima de $50M COP.", "Presentación de garantías de cumplimiento."],
                    legales: ["Inscripción en Cámara de Comercio.", "Certificado de antecedentes judiciales de los representantes legales."]
                },
                plano: { image: "https://picsum.photos/seed/coral_blueprint/1200/800.jpg", description: "Plano maestro de las zonas de intervención, mostrando los sitios de siembra, los nurseries y las áreas de monitoreo." }
            },
            {
                id: 'LIC-002', title: "Corredor Ecológico Oso de Anteojos", image: "https://picsum.photos/seed/oso_corredor/800/400.jpg",
                description: "Creación de un corredor biológico de 5,000 hectáreas para conectar poblaciones de oso de anteojos en la cordillera occidental.",
                capital: 620000000, location: [3.8893, -77.0764],
                requisitos: {
                    tecnicos: ["Experiencia en biología de la conservación y manejo de vida silvestre.", "Capacidad para realizar estudios de conectividad ecológica."],
                    financieros: ["Capacidad de inversión mínima de $75M COP.", "Presentación de un plan financiero a 5 años."],
                    legales: ["Acuerdos con propietarios de tierras.", "Permisos ambientales de la autoridad competente."]
                },
                plano: { image: "https://picsum.photos/seed/corridor_blueprint/1200/800.jpg", description: "Mapa del corredor ecológico propuesto, detallando las áreas a reforestar, los pasos de fauna y las zonas núcleo de hábitat." }
            },
            {
                id: 'LIC-003', title: "Filtro de Agua con Moringa para La Guajira", image: "https://picsum.photos/seed/moringa_guajira/800/400.jpg",
                description: "Implementación de 1,000 sistemas de filtración de agua con Moringa oleifera para comunidades wayúu en la Alta Guajira.",
                capital: 280000000, location: [11.9663, -72.3069],
                requisitos: {
                    tecnicos: ["Experiencia en tecnologías de tratamiento de agua de bajo costo.", "Capacidad para trabajar con comunidades indígenas."],
                    financieros: ["Capacidad de inversión mínima de $30M COP.", "Co-financiación del 20% por parte de la comunidad."],
                    legales: ["Consulta previa y consentimiento de las comunidades.", "Registro del proyecto ante la autoridad ambiental regional."]
                },
                plano: { image: "https://picsum.photos/seed/guajira_blueprint/1200/800.jpg", description: "Distribución geográfica de los sistemas de filtración en las comunidades seleccionadas, mostrando los puntos de agua y las viviendas beneficiadas." }
            },
            {
                id: 'LIC-004', title: "Laboratorio de Plásticos Biodegradables", image: "https://picsum.photos/seed/bioplastic_lab/800/400.jpg",
                description: "Establecimiento de un laboratorio en Cali para investigar y producir plásticos biodegradables a partir de residuos agrícolas.",
                capital: 750000000, location: [3.4516, -76.5319],
                requisitos: {
                    tecnicos: ["Equipo de investigación con doctorado en química de polímeros o biotecnología.", "Acceso a laboratorios de última generación."],
                    financieros: ["Capacidad de inversión mínima de $100M COP.", "Plan de sostenibilidad y escalabilidad a 3 años."],
                    legales: ["Propiedad intelectual sobre las tecnologías a desarrollar.", "Alianzas estratégicas con universidades o centros de investigación."]
                },
                plano: { image: "https://picsum.photos/seed/lab_blueprint/1200/800.jpg", description: "Diseño arquitectónico y de layout del laboratorio, incluyendo las áreas de investigación, producción y bodegas de materias primas." }
            }
        ];

        const mockActiveProjects = [
            { id: 1, title: "Reforestación del Alto Magdalena", image: "https://picsum.photos/seed/reforest1/800/400.jpg", applications: ["Reforestación", "Captura de carbono"], amount: "250,000,000", progress: 78, status: "in-progress", description: "Proyecto de reforestación de 500 hectáreas en la cuenca alta del río Magdalena.", location: [4.5709, -74.2973] },
            { id: 2, title: "Conservación de Manglares Caribe", image: "https://picsum.photos/seed/mangle1/800/400.jpg", applications: ["Conservación", "Biodiversidad"], amount: "180,000,000", progress: 100, status: "verified", description: "Protección y restauración de 200 hectáreas de manglar en el departamento de Atlántico.", location: [10.9639, -74.7964] },
            { id: 3, title: "Energía Solar para Chocó", image: "https://picsum.photos/seed/solar1/800/400.jpg", applications: ["Energías Renovables"], amount: "300,000,000", progress: 45, status: "in-progress", description: "Instalación de paneles solares en 15 comunidades rurales del Chocó.", location: [5.4696, -76.5223] }
        ];

        // --- UI Y UTILIDADES ---
        function showAlert(message, type = 'info') { /* ... sin cambios ... */ const alertContainer = document.getElementById('alertContainer'); const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-dismissible fade show`; alertDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; alertContainer.appendChild(alertDiv); setTimeout(() => { alertDiv.remove(); }, 5000); }
        function updateWalletUI(isConnected) { /* ... sin cambios ... */ const walletArea = document.getElementById('walletConnectionArea'); if (isConnected && userAddress) { const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`; walletArea.innerHTML = `<div class="d-flex align-items-center gap-2"><span class="badge bg-success">Celo</span><span>${shortAddress}</span><button class="btn btn-outline-light btn-sm" onclick="disconnectWallet()">Desconectar</button></div>`; } else { walletArea.innerHTML = `<button class="btn btn-outline-light" id="connectWalletBtn" onclick="connectWallet()"><i class="bi bi-wallet2 me-2"></i>Conectar Billetera</button>`; } }
        
        // --- CONEXIÓN A BLOCKCHAIN ---
        async function connectWallet() { /* ... sin cambios ... */ if (typeof window.ethereum === 'undefined') { showAlert('MetaMask no está instalado.', 'danger'); return; } const btn = document.getElementById('connectWalletBtn'); if (btn) { btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Conectando...'; btn.disabled = true; } try { await window.ethereum.request({ method: 'eth_requestAccounts' }); provider = new ethers.providers.Web3Provider(window.ethereum); signer = provider.getSigner(); userAddress = await signer.getAddress(); await checkAndSwitchNetwork(); updateWalletUI(true); showAlert('Billetera conectada.', 'success'); } catch (error) { showAlert('Error al conectar.', 'danger'); updateWalletUI(false); } }
        async function checkAndSwitchNetwork() { /* ... sin cambios ... */ const network = await provider.getNetwork(); if (network.chainId !== CELO_CHAIN_ID) { showAlert('Cambiando a Celo Mainnet...', 'warning'); try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_CHAIN_ID_HEX }] }); } catch (error) { if (error.code === 4902) { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CELO_CHAIN_ID_HEX, chainName: 'Celo Mainnet', rpcUrls: [CELO_MAINNET_RPC_URL], nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 }, blockExplorerUrls: ['https://celoscan.io/'] }] }); } } } }
        function disconnectWallet() { userAddress = null; provider = null; signer = null; updateWalletUI(false); showAlert('Billetera desconectada.', 'info'); }

        // --- MODAL FUNCTIONS ---
        function showRequisitosModal(projectId) {
            const project = mockLicitacionProjects.find(p => p.id === projectId);
            if (!project) return;
            document.getElementById('requisitosModalTitle').innerText = `Requisitos - ${project.title}`;
            document.getElementById('requisitosModalBody').innerHTML = `
                <h6>Requisitos Técnicos</h6><ul>${project.requisitos.tecnicos.map(req => `<li>${req}</li>`).join('')}</ul>
                <h6>Requisitos Financieros</h6><ul>${project.requisitos.financieros.map(req => `<li>${req}</li>`).join('')}</ul>
                <h6>Requisitos Legales</h6><ul>${project.requisitos.legales.map(req => `<li>${req}</li>`).join('')}</ul>
            `;
            new bootstrap.Modal(document.getElementById('requisitosModal')).show();
        }

        function showPlanosModal(projectId) {
            const project = mockLicitacionProjects.find(p => p.id === projectId);
            if (!project) return;
            document.getElementById('planosModalTitle').innerText = `Planos - ${project.title}`;
            document.getElementById('planosModalBody').innerHTML = `
                <img src="${project.plano.image}" class="img-fluid rounded mb-3" alt="Plano del proyecto">
                <p>${project.plano.description}</p>
            `;
            new bootstrap.Modal(document.getElementById('planosModal')).show();
        }

        // --- CARGAR PROYECTOS ---
        function loadLicitacionProjects() {
            const container = document.getElementById('licitacionContainer');
            container.innerHTML = '';
            mockLicitacionProjects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="licitacion-card h-100">
                        <img src="${project.image}" class="licitacion-img" alt="${project.title}">
                        <div class="licitacion-header">ID: ${project.id}</div>
                        <div class="card-body">
                            <h5>${project.title}</h5>
                            <p>${project.description}</p>
                            <h6 class="mt-3">Monto Estimado:</h6>
                            <p class="amount-highlight">$ ${project.capital.toLocaleString('es-CO')} COP</p>
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-outline-primary" onclick="showRequisitosModal('${project.id}')"><i class="bi bi-clipboard-check me-2"></i>Ver Requisitos</button>
                                <button class="btn btn-primary" onclick="showPlanosModal('${project.id}')"><i class="bi bi-map me-2"></i>Ver Planos</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function loadActiveProjects() { /* ... sin cambios ... */ const container = document.getElementById('projectsContainer'); container.innerHTML = ''; mockActiveProjects.forEach(project => { const statusText = { 'in-progress': 'En Ejecución', 'verified': 'Verificado' }[project.status] || 'Pendiente'; const card = document.createElement('div'); card.className = 'col-md-6 col-lg-4'; card.innerHTML = `<div class="project-card h-100"><img src="${project.image}" class="project-img" alt="${project.title}"><div class="project-header">${project.title}</div><div class="card-body"><p class="mb-2">${project.description}</p><div class="project-tags mb-3">${project.applications.map(app => `<span class="tag">${app}</span>`).join('')}</div><div class="amount-highlight">$ ${parseInt(project.amount).toLocaleString('es-CO')} COP</div><div class="progress-container my-3"><div class="progress"><div class="progress-bar" style="width: ${project.progress}%"></div></div><small class="text-muted">${project.progress}% completado</small></div><span class="badge-status status-${project.status}">${statusText}</span></div></div>`; container.appendChild(card); }); }

        // --- HANDLERS Y EVENTOS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map').setView([4.5709, -74.2973], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            
            const allProjects = [...mockLicitacionProjects, ...mockActiveProjects];
            allProjects.forEach(project => {
                const popupContent = `<img src="${project.image}" style="width:200px; height:100px; object-fit:cover; border-radius:5px;"><h6>${project.title}</h6><p>${project.description.substring(0, 100)}...</p><a href="#" class="btn btn-sm btn-primary" onclick="scrollToSection('${project.id.startsWith('LIC') ? 'licitacion' : 'proyectos'}')">Ver más</a>`;
                L.marker(project.location).addTo(map).bindPopup(popupContent);
            });

            // Initial load
            loadLicitacionProjects();
            loadActiveProjects();
            updateWalletUI(false);

            // Contact form handler
            const contactForm = document.getElementById('contactForm');
            if (contactForm) { contactForm.addEventListener('submit', function(e) { e.preventDefault(); showAlert('Mensaje enviado con éxito. ¡Gracias por contactarnos!', 'success'); contactForm.reset(); }); }

            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => { if (accounts.length === 0) disconnectWallet(); else window.location.reload(); });
                window.ethereum.on('chainChanged', () => window.location.reload());
            }
        });

        // --- FUNCIONES GLOBALES ---
        function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
    </script>
</body>
</html>
