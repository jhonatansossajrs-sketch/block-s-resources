<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidad de Recursos Ambientales - CCOP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #81C784;
            --accent-color: #FFC107;
            --dark-color: #1B5E20;
            --light-bg: #F1F8E9;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 60px 0;
            margin-bottom: 30px;
        }
        .stats-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-card .card-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .project-card {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
        }
        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
        }
        .project-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .project-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .project-body {
            padding: 20px;
        }
        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }
        .tag {
            background-color: var(--light-bg);
            color: var(--dark-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .amount-highlight {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .progress-container {
            margin: 15px 0;
        }
        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        .progress-bar {
            background-color: var(--secondary-color);
            border-radius: 5px;
        }
        .milestone {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        .milestone-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        .milestone-icon.completed {
            background-color: var(--accent-color);
        }
        .transaction-item {
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 0 5px 5px 0;
            font-size: 0.9rem;
        }
        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 10px 10px;
        }
        .nav-tabs {
            border-bottom: 2px solid var(--secondary-color);
        }
        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 500;
            border: none;
            border-bottom: 3px solid transparent;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
            border-bottom: 3px solid var(--primary-color);
        }
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }
        .badge-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .status-pending { background-color: #FFF3E0; color: #E65100; }
        .status-in-progress { background-color: #E3F2FD; color: #0D47A1; }
        .status-verified { background-color: #E8F5E9; color: #1B5E20; }
        .status-closed { background-color: #F3E5F5; color: #4A148C; }
        .detail-modal .modal-header { background-color: var(--primary-color); color: white; }
       
        .fund-flow { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 20px 0; 
            position: relative; 
        }
        .fund-flow::before { 
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 0; 
            right: 0; 
            height: 3px; 
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color)); 
            z-index: 1; 
        }
        .fund-step { 
            background-color: white; 
            border: 3px solid var(--primary-color); 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 2; 
            position: relative; 
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .fund-step.active { 
            background-color: var(--primary-color); 
            color: white; 
        }
        .fund-step-label { 
            position: absolute; 
            bottom: -30px; 
            white-space: nowrap; 
            font-size: 0.85rem; 
            width: 120px; 
            text-align: center; 
            color: white;
            font-weight: 500;
        }
        .wallet-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .network-badge {
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }
        .connection-status {
            font-size: 0.9rem;
            color: #ccc;
        }
        .trace-step {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }
        .trace-step::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 30px;
            bottom: -20px;
            width: 2px;
            background-color: var(--secondary-color);
        }
        .trace-step:last-child::before {
            display: none;
        }
        .trace-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .about-section, .contact-section {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }
        .contact-form .form-control {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-tree-fill me-2"></i>Trazabilidad Ambiental CCOP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" href="#inicio">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#proyectos">Proyectos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#trazabilidad">Trazabilidad</a></li>
                    <li class="nav-item"><a class="nav-link" href="#quienes-somos">Quienes Somos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#contactanos">Contáctanos</a></li>
                    <li class="nav-item d-flex align-items-center ms-3">
                        <div id="walletConnectionArea"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="inicio">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">Trazabilidad Transparente de Recursos Ambientales</h1>
                    <p class="lead mb-4">Conecta tu billetera para interactuar con la blockchain de Celo y seguir el camino de cada peso destinado a proyectos ambientales en Colombia.</p>
                    <div class="d-flex gap-3">
                        <button class="btn btn-light btn-lg" onclick="scrollToSection('proyectos')">
                            <i class="bi bi-search me-2"></i>Explorar Proyectos
                        </button>
                        <button class="btn btn-outline-light btn-lg" onclick="showHowItWorks()">
                            <i class="bi bi-play-circle me-2"></i>Cómo Funciona
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="fund-flow">
                        <div class="fund-step active">
                            <i class="bi bi-cash"></i>
                            <span class="fund-step-label">Fondos COP</span>
                        </div>
                        <div class="fund-step active">
                            <i class="bi bi-currency-exchange"></i>
                            <span class="fund-step-label">Conversión CCOP</span>
                        </div>
                        <div class="fund-step active">
                            <i class="bi bi-clipboard-check"></i>
                            <span class="fund-step-label">Asignación</span>
                        </div>
                        <div class="fund-step active">
                            <i class="bi bi-tree"></i>
                            <span class="fund-step-label">Impacto</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="container mb-5">
        <div class="row">
            <div class="col-md-3 col-sm-6">
                <div class="stats-card text-center">
                    <div class="card-icon"><i class="bi bi-currency-exchange"></i></div>
                    <h3 class="fw-bold" id="totalFunds">$2.5B</h3>
                    <p class="text-muted">Recursos Totales</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card text-center">
                    <div class="card-icon"><i class="bi bi-diagram-3"></i></div>
                    <h3 class="fw-bold" id="activeProjects">142</h3>
                    <p class="text-muted">Proyectos Activos</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card text-center">
                    <div class="card-icon"><i class="bi bi-people"></i></div>
                    <h3 class="fw-bold">28</h3>
                    <p class="text-muted">Organizaciones</p>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="stats-card text-center">
                    <div class="card-icon"><i class="bi bi-check-circle"></i></div>
                    <h3 class="fw-bold">89%</h3>
                    <p class="text-muted">Trazabilidad Completa</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Projects Section -->
    <section class="container mb-5" id="proyectos">
        <h2 class="mb-4">Explorar Proyectos</h2>
        <div class="row" id="projectsContainer">
            <!-- Proyectos se cargarán aquí dinámicamente -->
        </div>
    </section>

    <!-- Trazabilidad Section -->
    <section class="container mb-5" id="trazabilidad">
        <h2 class="mb-4">Trazabilidad de Recursos</h2>
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card border-0 shadow">
                    <div class="card-body p-5">
                        <h4 class="mb-4">Flujo Completo de un Proyecto</h4>
                        <div class="trace-step">
                            <div class="trace-icon"><i class="bi bi-cash"></i></div>
                            <h6>1. Recepción de Fondos</h6>
                            <p>Los recursos en COP ingresan al fondo ambiental y se convierten a CCOP en la blockchain.</p>
                        </div>
                        <div class="trace-step">
                            <div class="trace-icon"><i class="bi bi-building"></i></div>
                            <h6>2. Asignación a Proyecto</h6>
                            <p>Se aprueba y asigna el monto a un proyecto verificado con contrato inteligente.</p>
                        </div>
                        <div class="trace-step">
                            <div class="trace-icon"><i class="bi bi-geo-alt"></i></div>
                            <h6>3. Ejecución en Campo</h6>
                            <p>La organización ejecuta actividades (siembra, educación, monitoreo) y reporta avances.</p>
                        </div>
                        <div class="trace-step">
                            <div class="trace-icon"><i class="bi bi-camera"></i></div>
                            <h6>4. Verificación Independiente</h6>
                            <p>Auditores verifican resultados con fotos, GPS y reportes técnicos.</p>
                        </div>
                        <div class="trace-step">
                            <div class="trace-icon"><i class="bi bi-check-circle"></i></div>
                            <h6>5. Cierre y Liberación</h6>
                            <p>Se valida el impacto y se registra permanentemente en blockchain.</p>
                        </div>
                        <div class="text-center mt-4">
                            <button class="btn btn-success btn-lg" onclick="openTraceModal()">
                                <i class="bi bi-eye me-2"></i>Ver Trazabilidad Detallada
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quienes Somos Section -->
    <section class="container about-section" id="quienes-somos">
        <h2 class="mb-4">Quienes Somos</h2>
        <p>Somos CCOP, una plataforma innovadora basada en blockchain para la trazabilidad de tus proyectos ambientales usando nuestra plataforma. Garantizamos transparencia total en el uso de recursos, desde la donación hasta el impacto real en el medio ambiente. Nuestro equipo de expertos en tecnología y sostenibilidad trabaja para empoderar a organizaciones y ciudadanos en Colombia.</p>
        <ul>
            <li><strong>Misión:</strong> Proporcionar herramientas de trazabilidad inmutable para proyectos ecológicos.</li>
            <li><strong>Visión:</strong> Un mundo donde cada peso invertido en el ambiente sea auditable y efectivo.</li>
            <li><strong>Valores:</strong> Transparencia, innovación y compromiso ambiental.</li>
        </ul>
    </section>

    <!-- Contáctanos Section -->
    <section class="container contact-section" id="contactanos">
        <h2 class="mb-4">Contáctanos</h2>
        <p>¿Quieres rastrear tus proyectos ambientales o colaborar con nosotros? Envíanos un mensaje.</p>
        <form id="contactForm" class="contact-form">
            <input type="text" class="form-control" placeholder="Tu Nombre" required>
            <input type="email" class="form-control" placeholder="Tu Email" required>
            <textarea class="form-control" rows="5" placeholder="Tu Mensaje" required></textarea>
            <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="mb-3">Trazabilidad Ambiental CCOP</h5>
                    <p>Plataforma blockchain para la gestión transparente de recursos ambientales en Colombia.</p>
                </div>
                <div class="col-md-4">
                    <h5 class="mb-3">Enlaces</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white-50">Acerca de</a></li>
                        <li><a href="#" class="text-white-50">Documentación técnica</a></li>
                        <li><a href="#" class="text-white-50">Explorador de bloques</a></li>
                        <li><a href="#" class="text-white-50">Contacto</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="mb-3">Conéctate</h5>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-white fs-4"><i class="bi bi-twitter"></i></a>
                        <a href="#" class="text-white fs-4"><i class="bi bi-linkedin"></i></a>
                        <a href="#" class="text-white fs-4"><i class="bi bi-github"></i></a>
                        <a href="#" class="text-white fs-4"><i class="bi bi-envelope"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4 bg-white-50">
            <div class="text-center">
                <p class="mb-0">© 2023 Trazabilidad Ambiental CCOP. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- How It Works Modal -->
    <div class="modal fade" id="howItWorksModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Cómo Funciona la Trazabilidad de Recursos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="howItWorksAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                    1. Conexión a la Blockchain
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#howItWorksAccordion">
                                <div class="accordion-body">
                                    <p>Conecta tu billetera MetaMask a la red Celo para interactuar de forma segura con el protocolo.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                    2. Lectura de Datos On-Chain
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#howItWorksAccordion">
                                <div class="accordion-body">
                                    <p>La dApp lee directamente los contratos en Celo para mostrar proyectos y transacciones en tiempo real.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                    3. Trazabilidad Inmutable
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#howItWorksAccordion">
                                <div class="accordion-body">
                                    <p>Cada peso y su impacto queda grabado para siempre en la blockchain.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trazabilidad Detallada Modal -->
    <div class="modal fade" id="traceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Trazabilidad Completa - Proyecto #142</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Transacciones en Blockchain</h6>
                            <div class="transaction-item">
                                <strong>Tx: 0x123...abc</strong><br>
                                <small>10,000,000 COP → 5,000 CCOP</small>
                            </div>
                            <div class="transaction-item">
                                <strong>Tx: 0x456...def</strong><br>
                                <small>Asignación a Proyecto Reforestación Cauca</small>
                            </div>
                            <div class="transaction-item">
                                <strong>Tx: 0x789...ghi</strong><br>
                                <small>Verificación de 1,200 árboles plantados</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Evidencia Física</h6>
                            <img src="https://via.placeholder.com/600x300?text=Antes+y+Después" class="img-fluid rounded mb-3" alt="Evidencia">
                            <p><strong>GPS:</strong> 2.4451° N, 76.6123° W</p>
                            <p><strong>Auditor:</strong> EcoVerifica S.A.S</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-success">Ver en Celoscan</button>
                    <button class="btn btn-success">Descargar Reporte PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   
    <script>
        // --- CONFIGURACIÓN DE BLOCKCHAIN ---
        const CELO_MAINNET_RPC_URL = "https://forno.celo.org";
        const CELO_CHAIN_ID = 42220;
        const CELO_CHAIN_ID_HEX = "0xa4ec";
        const CONTRACT_ADDRESS = "0x1234567890123456789012345678901234567890";
        const CONTRACT_ABI = [ /* ... ABI ... */ ];

        let provider, signer, contract, userAddress = null;

        // --- DATOS DE PROYECTOS DE EJEMPLO (hasta conectar con blockchain) ---
        const mockProjects = [
            {
                id: 142,
                title: "Reforestación Río Cauca",
                image: "https://via.placeholder.com/600x400?text=Reforestación+Río+Cauca",
                applications: ["Reforestación", "Conservación de suelos", "Captura de carbono"],
                amount: "150,000,000",
                progress: 78,
                status: "in-progress",
                description: "Plantación de 5,000 árboles nativos en zonas degradadas del Cauca."
            },
            {
                id: 89,
                title: "Educación Ambiental Escolar",
                image: "https://via.placeholder.com/600x400?text=Educación+Ambiental",
                applications: ["Educación", "Concienciación", "Formación juvenil"],
                amount: "85,000,000",
                progress: 100,
                status: "verified",
                description: "Talleres en 40 colegios de Medellín sobre reciclaje y sostenibilidad."
            },
            {
                id: 201,
                title: "Monitoreo de Biodiversidad",
                image: "https://via.placeholder.com/600x400?text=Monitoreo+Biodiversidad",
                applications: ["Investigación", "Conservación", "Tecnología"],
                amount: "220,000,000",
                progress: 45,
                status: "in-progress",
                description: "Cámaras trampa y sensores IoT en Parque Nacional Natural."
            }
        ];

        // --- UI Y UTILIDADES ---
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => { alertDiv.remove(); }, 5000);
        }

        function updateWalletUI(isConnected) {
            const walletArea = document.getElementById('walletConnectionArea');
            if (isConnected && userAddress) {
                const shortAddress = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                walletArea.innerHTML = `
                    <div class="wallet-info">
                        <span class="network-badge">Celo</span>
                        <span>${shortAddress}</span>
                        <button class="btn btn-outline-light btn-sm" onclick="disconnectWallet()">Desconectar</button>
                    </div>
                `;
            } else {
                walletArea.innerHTML = `
                    <button class="btn btn-outline-light" id="connectWalletBtn" onclick="connectWallet()">
                        <i class="bi bi-wallet2 me-2"></i>Conectar Billetera
                    </button>
                `;
            }
        }

        // --- CONEXIÓN A BLOCKCHAIN ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showAlert('MetaMask no está instalado.', 'danger');
                return;
            }
            const btn = document.getElementById('connectWalletBtn');
            if (btn) { btn.innerHTML = '<span class="loading-spinner"></span> Conectando...'; btn.disabled = true; }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) throw new Error("Conexión rechazada.");

                userAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                await checkAndSwitchNetwork();
                updateWalletUI(true);
                showAlert('Billetera conectada.', 'success');
                loadProjects(); // Carga proyectos (mock por ahora)
            } catch (error) {
                showAlert(error.message || 'Error al conectar.', 'danger');
                updateWalletUI(false);
            }
        }

        async function checkAndSwitchNetwork() {
            const network = await provider.getNetwork();
            if (network.chainId !== CELO_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CELO_CHAIN_ID_HEX }],
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CELO_CHAIN_ID_HEX,
                                chainName: 'Celo Mainnet',
                                rpcUrls: [CELO_MAINNET_RPC_URL],
                                nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
                                blockExplorerUrls: ['https://celoscan.io/'],
                            }],
                        });
                    }
                }
            }
        }

        function disconnectWallet() {
            userAddress = null; provider = null; signer = null; contract = null;
            updateWalletUI(false);
            showAlert('Billetera desconectada.', 'info');
            document.getElementById('projectsContainer').innerHTML = `
                <div class="col-12 text-center connection-status">
                    <i class="bi bi-wallet2" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="mt-3">Conecta tu billetera para ver los proyectos.</p>
                </div>
            `;
        }

        // --- CARGAR PROYECTOS ---
        function loadProjects() {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '';

            mockProjects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="project-card">
                        <img src="${project.image}" class="project-img" alt="${project.title}">
                        <div class="project-header">${project.title}</div>
                        <div class="project-body">
                            <p class="mb-2">${project.description}</p>
                            <div class="project-tags">
                                ${project.applications.map(app => `<span class="tag">${app}</span>`).join('')}
                            </div>
                            <div class="amount-highlight mt-3">$ ${parseInt(project.amount).toLocaleString()} COP</div>
                            <div class="progress-container">
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${project.progress}%"></div>
                                </div>
                                <small class="text-muted">${project.progress}% completado</small>
                            </div>
                            <span class="badge-status status-${project.status}">
                                ${project.status === 'in-progress' ? 'En progreso' : project.status === 'verified' ? 'Verificado' : 'Pendiente'}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- HANDLER PARA FORMULARIO DE CONTACTO ---
        document.addEventListener('DOMContentLoaded', function() {
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    showAlert('Mensaje enviado con éxito. ¡Gracias por contactarnos!', 'success');
                    contactForm.reset();
                });
            }
        });

        // --- MODALES ---
        function showHowItWorks() { new bootstrap.Modal(document.getElementById('howItWorksModal')).show(); }
        function openTraceModal() { new bootstrap.Modal(document.getElementById('traceModal')).show(); }
        function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', function() {
            updateWalletUI(false);
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) disconnectWallet();
                    else window.location.reload();
                });
            }
        });
    </script>
</body>
</html>
