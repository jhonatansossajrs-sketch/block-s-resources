<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidad de Recursos Ambientales - CCOP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        /* Estilos base */
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #81C784;
            --accent-color: #FFC107;
            --dark-color: #1B5E20;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; color: #333; }
        .navbar { background-color: var(--primary-color); }
        .navbar-brand { color: white !important; font-weight: bold; }
        .hero-section { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 60px 0; }
        .stats-card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; transition: .3s; }
        .stats-card:hover { transform: translateY(-5px); }
        .footer { background-color: var(--dark-color); color: white; padding: 30px 0; margin-top: 50px; }
        .wallet-info { color: white; display: flex; align-items: center; gap: 10px; }
        .network-badge { background-color: var(--accent-color); color: var(--dark-color); padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .loading-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert-container { position: fixed; top: 80px; right: 20px; z-index: 1050; max-width: 350px; }
    </style>
</head>
<body>
    <div class="alert-container" id="alertContainer"></div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand"><i class="bi bi-tree-fill me-2"></i>Trazabilidad Ambiental CCOP</a>
            <div id="walletConnectionArea"></div>
        </div>
    </nav>

    <section class="hero-section text-center">
        <div class="container">
            <h1 class="fw-bold">Trazabilidad Transparente de Recursos Ambientales</h1>
            <p class="lead">Conecta tu billetera para interactuar con la blockchain de Celo.</p>
            <button class="btn btn-light btn-lg" onclick="connectWallet()"><i class="bi bi-wallet2 me-2"></i>Conectar Billetera</button>
        </div>
    </section>

    <section class="container my-5">
        <div class="row" id="projectsContainer">
            <div class="col-12 text-center text-muted">
                <i class="bi bi-wallet2" style="font-size:3rem;"></i>
                <p>Por favor, conecta tu billetera MetaMask para ver los proyectos.</p>
            </div>
        </div>
    </section>

    <footer class="footer text-center">
        <div class="container">
            <p class="mb-0">© 2025 Trazabilidad Ambiental CCOP. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- CONFIGURACIÓN DE BLOCKCHAIN ---
        const CELO_MAINNET_RPC_URL = "https://forno.celo.org";
        const CELO_CHAIN_ID = 42220;
        const CELO_CHAIN_ID_HEX = "0xa4ec";
        const CONTRACT_ADDRESS = "0x1234567890123456789012345678901234567890"; // reemplaza con el tuyo
        const CONTRACT_ABI = [];

        let provider, signer, contract, userAddress = null;

        // ALERTAS
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // ACTUALIZAR UI DE CONEXIÓN
        function updateWalletUI(isConnected) {
            const walletArea = document.getElementById('walletConnectionArea');
            if (isConnected && userAddress) {
                const shortAddr = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                walletArea.innerHTML = `
                    <div class="wallet-info">
                        <span class="network-badge">Celo</span>
                        <span>${shortAddr}</span>
                        <button class="btn btn-outline-light btn-sm" onclick="disconnectWallet()">Desconectar</button>
                    </div>
                `;
            } else {
                walletArea.innerHTML = `
                    <button class="btn btn-outline-light" id="connectWalletBtn" onclick="connectWallet()">
                        <i class="bi bi-wallet2 me-2"></i>Conectar Billetera
                    </button>
                `;
            }
        }

        // CONECTAR A METAMASK
        async function connectWallet() {
            if (!window.ethereum) {
                showAlert("MetaMask no está instalado.", "danger");
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                await checkAndSwitchNetwork();
                updateWalletUI(true);
                showAlert("Billetera conectada exitosamente.", "success");
                loadOnChainData();
            } catch (error) {
                showAlert(`Error: ${error.message}`, "danger");
                updateWalletUI(false);
            }
        }

        // CAMBIO DE RED
        async function checkAndSwitchNetwork() {
            const network = await provider.getNetwork();
            if (network.chainId !== CELO_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CELO_CHAIN_ID_HEX }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CELO_CHAIN_ID_HEX,
                                chainName: 'Celo Mainnet',
                                rpcUrls: [CELO_MAINNET_RPC_URL],
                                nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
                                blockExplorerUrls: ['https://celoscan.io/']
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // DESCONECTAR
        function disconnectWallet() {
            userAddress = null;
            updateWalletUI(false);
            showAlert("Billetera desconectada.", "info");
            document.getElementById('projectsContainer').innerHTML = `
                <div class="col-12 text-center text-muted">
                    <i class="bi bi-wallet2" style="font-size:3rem;"></i>
                    <p>Por favor, conecta tu billetera MetaMask para ver los proyectos.</p>
                </div>
            `;
        }

        // CARGAR DATOS ONCHAIN
        async function loadOnChainData() {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-success">
                        <h4>¡Conexión Exitosa!</h4>
                        <p>Estás conectado con la dirección: <strong>${userAddress}</strong></p>
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => updateWalletUI(false));
    </script>
</body>
</html>
